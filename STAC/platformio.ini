; PlatformIO Project Configuration File
;   - for the STAC refactoring project

; ======================================

[platformio]
default_envs = atom-matrix

; ======================================

[common_settings]
framework = arduino
build_type = debug
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
upload_protocol = esptool

; Custom partition table for OTA support
board_build.partitions = partitions/4M_OTA_noCD.csv

; Register custom target for merged binary generation (on-demand via -t merged)
; Also register build version generator (runs before every build)
extra_scripts = 
    scripts/custom_targets.py
    scripts/build_version.py

; ======================================

[debug_level]
build_flags =
    -DCORE_DEBUG_LEVEL=3

; ======================================

[core_libs]
lib_deps = 
    https://github.com/Xylopyrographer/LiteLED.git#v3.0.0
    https://github.com/Xylopyrographer/XP_Button.git#v1.0.3

; ======================================

[env:atom-matrix]
extends = common_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = m5stack-atom

lib_deps = 
    ${core_libs.lib_deps}
    https://github.com/tanakamasayuki/I2C_MPU6886.git

build_flags =
    ${debug_level.build_flags}
    -DBOARD_M5STACK_ATOM_MATRIX

; Build filter - exclude Waveshare-specific files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/QMI8658_IMU.cpp>

; ======================================

[env:waveshare-s3]
extends = common_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = ws_esp32_s3_matrix
upload_port = /dev/cu.usbmodem143101
; esp32-s3-devkitc-1
build_flags =
    ${debug_level.build_flags}
    -DBOARD_HAS_PSRAM
    -DBOARD_WAVESHARE_ESP32_S3_MATRIX
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1

; Build filter - exclude ATOM-specific files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/MPU6886_IMU.cpp>

lib_deps = 
    ${core_libs.lib_deps}
    lewisxhe/SensorLib@^0.2.5

# Ensure bootloader selection resolves correctly for S3
board_upload.flash_size = 4MB
board_build.flash_mode = qio
board_build.f_flash = 80000000L
board_build.arduino.memory_type = qio_qspi

; ======================================
; RELEASE BUILDS (for production)
; ======================================

[release_settings]
framework = arduino
build_type = release
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
upload_protocol = esptool

; Custom partition table for OTA support
board_build.partitions = partitions/4M_OTA_noCD.csv

; Register custom target for merged binary generation (on-demand via -t merged)
; Also register build version generator (runs before every build)
extra_scripts = 
    scripts/custom_targets.py
    scripts/build_version.py

; ======================================

[release_debug_level]
build_flags =
    -DCORE_DEBUG_LEVEL=0

; ======================================

[env:atom-matrix-release]
extends = release_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = m5stack-atom

lib_deps = 
    ${core_libs.lib_deps}
    https://github.com/tanakamasayuki/I2C_MPU6886.git

build_flags =
    ${release_debug_level.build_flags}
    -DBOARD_M5STACK_ATOM_MATRIX

; Build filter - exclude Waveshare-specific files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/QMI8658_IMU.cpp>

; ======================================

[env:waveshare-s3-release]
extends = release_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = ws_esp32_s3_matrix
upload_port = /dev/cu.usbmodem143101
; esp32-s3-devkitc-1
build_flags =
    ${release_debug_level.build_flags}
    -DBOARD_HAS_PSRAM
    -DBOARD_WAVESHARE_ESP32_S3_MATRIX
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1

; Build filter - exclude ATOM-specific files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/MPU6886_IMU.cpp>

lib_deps = 
    ${core_libs.lib_deps}
    lewisxhe/SensorLib@^0.2.5

# Ensure bootloader selection resolves correctly for S3
board_upload.flash_size = 4MB
board_build.flash_mode = qio
board_build.f_flash = 80000000L
board_build.arduino.memory_type = qio_qspi

; ======================================

; //  --- EOF --- //

; board_upload.flash_size = 4MB
; board_build.arduino.memory_type = qio_qspi
; board_build.flash_mode = qio
; board_build.f_flash = 80000000L
; build_flags =
;     -DBOARD_HAS_PSRAM
; board_build.partitions = 4MB_ota_only.csv