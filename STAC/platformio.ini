; PlatformIO Project Configuration File
;   - for the STAC refactoring project

; ======================================

[platformio]
src_dir = src
default_envs = atom-matrix

; ======================================

[common_settings]
framework = arduino
build_type = debug
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
upload_protocol = esptool

; Custom partition table for OTA support
board_build.partitions = partitions/4M_OTA_noCD.csv

; Register custom target for merged binary generation (on-demand via -t merged)
; Also register build version generator (runs before every build)
extra_scripts = 
    scripts/custom_targets.py
    scripts/build_version.py

; ======================================

[debug_level]
build_flags =
    -DCORE_DEBUG_LEVEL=3

; ======================================
; RELEASE BUILDS (for production)
; ======================================

[release_settings]
framework = arduino
build_type = release
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
upload_protocol = esptool

; Custom partition table for OTA support
board_build.partitions = partitions/4M_OTA_noCD.csv

; Register custom target for merged binary generation (on-demand via -t merged)
; Also register build version generator (runs before every build)
extra_scripts = 
    scripts/custom_targets.py
    scripts/build_version.py

; ======================================

[release_debug_level]
build_flags =
    -DCORE_DEBUG_LEVEL=0

; ======================================

[core_libs]
lib_deps = 
    https://github.com/Xylopyrographer/LiteLED.git#v3.0.1
    https://github.com/Xylopyrographer/XP_Button.git#v1.0.3

; ======================================

[env:atom-matrix]
extends = common_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = m5stack-atom

lib_deps = 
    ${core_libs.lib_deps}
    https://github.com/tanakamasayuki/I2C_MPU6886.git

build_flags =
    ${debug_level.build_flags}
    -DBOARD_CONFIG_FILE=\"BoardConfigs/AtomMatrix_Config.h\"

; Build filter - exclude Waveshare-specific and TFT files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/QMI8658_IMU.cpp>
    -<Hardware/Display/TFT/*>
    -<Hardware/Power/AXP192.cpp>

; ======================================

[env:atom-matrix-release]
extends = release_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = m5stack-atom

lib_deps = 
    ${core_libs.lib_deps}
    https://github.com/tanakamasayuki/I2C_MPU6886.git

build_flags =
    ${release_debug_level.build_flags}
    -DBOARD_CONFIG_FILE=\"BoardConfigs/AtomMatrix_Config.h\"

; Build filter - exclude Waveshare-specific and TFT files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/QMI8658_IMU.cpp>
    -<Hardware/Display/TFT/*>
    -<Hardware/Power/AXP192.cpp>

; ======================================

[env:waveshare-s3]
extends = common_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = ws_esp32_s3_matrix
upload_port = /dev/cu.usbmodem143101
; esp32-s3-devkitc-1
build_flags =
    ${debug_level.build_flags}
    -DBOARD_CONFIG_FILE=\"BoardConfigs/WaveshareS3_Config.h\"
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1

; Build filter - exclude ATOM-specific files and TFT files (LED matrix board)
build_src_filter = 
    +<*>
    -<Hardware/Sensors/MPU6886_IMU.cpp>
    -<Hardware/Display/TFT/*>
    -<Hardware/Power/AXP192.cpp>

lib_deps = 
    ${core_libs.lib_deps}
    lewisxhe/SensorLib@^0.2.5

# Ensure bootloader selection resolves correctly for S3
board_upload.flash_size = 4MB
board_build.flash_mode = qio
board_build.f_flash = 80000000L
board_build.arduino.memory_type = qio_qspi

; ======================================

[env:waveshare-s3-release]
extends = release_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = ws_esp32_s3_matrix
upload_port = /dev/cu.usbmodem143101
; esp32-s3-devkitc-1
build_flags =
    ${release_debug_level.build_flags}
    -DBOARD_CONFIG_FILE=\"BoardConfigs/WaveshareS3_Config.h\"
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1

; Build filter - exclude ATOM-specific files and TFT files (LED matrix board)
build_src_filter = 
    +<*>
    -<Hardware/Sensors/MPU6886_IMU.cpp>
    -<Hardware/Display/TFT/*>
    -<Hardware/Power/AXP192.cpp>

lib_deps = 
    ${core_libs.lib_deps}
    lewisxhe/SensorLib@^0.2.5

# Ensure bootloader selection resolves correctly for S3
board_upload.flash_size = 4MB
board_build.flash_mode = qio
board_build.f_flash = 80000000L
board_build.arduino.memory_type = qio_qspi

; ======================================

[env:m5stickc-plus]
extends = common_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
; Use m5stack-atom as base (same ESP32-PICO-D4 chip) - m5stick-c has board file issues
board = m5stack-atom

lib_deps = 
    ${core_libs.lib_deps}
    https://github.com/tanakamasayuki/I2C_MPU6886.git
    moononournation/GFX Library for Arduino@^1.6.3

build_flags =
    ${debug_level.build_flags}
    -DBOARD_CONFIG_FILE=\"BoardConfigs/M5StickCPlus_Config.h\"
    -ULITTLE_FOOT_PRINT  ; CRITICAL: Enable text rendering in Arduino_GFX

; Build filter - exclude LED matrix and Waveshare-specific files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/QMI8658_IMU.cpp>
    -<Hardware/Display/Matrix5x5/*>
    -<Hardware/Display/Matrix8x8/*>

; ======================================

[env:display-offset-tool]
extends = common_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = m5stack-atom

lib_deps = 
    ${core_libs.lib_deps}
    lovyan03/LovyanGFX@^1.2.0

; ======================================

[env:m5stickc-plus-release]
extends = release_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = m5stack-atom

lib_deps = 
    ${core_libs.lib_deps}
    https://github.com/tanakamasayuki/I2C_MPU6886.git
    moononournation/GFX Library for Arduino@^1.6.3

build_flags =
    ${release_debug_level.build_flags}
    -DBOARD_CONFIG_FILE=\"BoardConfigs/M5StickCPlus_Config.h\"
    -ULITTLE_FOOT_PRINT  ; CRITICAL: Enable text rendering in Arduino_GFX

; Build filter - exclude LED matrix and Waveshare-specific files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/QMI8658_IMU.cpp>
    -<Hardware/Display/Matrix5x5/*>
    -<Hardware/Display/Matrix8x8/*>

; ======================================

[env:lilygo-t-display]
extends = common_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = lilygo-t-display
upload_port = /dev/cu.wchusbserial531C0069211

lib_deps = 
    ${core_libs.lib_deps}
    moononournation/GFX Library for Arduino@^1.6.3

build_flags =
    ${debug_level.build_flags}
    -DBOARD_CONFIG_FILE=\"BoardConfigs/LilygoTDisplay_Config.h\"
    -ULITTLE_FOOT_PRINT  ; CRITICAL: Enable text rendering in Arduino_GFX

; Build filter - exclude LED matrix and IMU-specific files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/QMI8658_IMU.cpp>
    -<Hardware/Sensors/MPU6886_IMU.cpp>
    -<Hardware/Display/Matrix5x5/*>
    -<Hardware/Display/Matrix8x8/*>
    -<Hardware/Power/AXP192.cpp>

; ======================================

[env:lilygo-t-display-release]
extends = release_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = lilygo-t-display

lib_deps = 
    ${core_libs.lib_deps}
    moononournation/GFX Library for Arduino@^1.6.3

build_flags =
    ${release_debug_level.build_flags}
    -DBOARD_CONFIG_FILE=\"BoardConfigs/LilygoTDisplay_Config.h\"
    -ULITTLE_FOOT_PRINT  ; CRITICAL: Enable text rendering in Arduino_GFX

; Build filter - exclude LED matrix and IMU-specific files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/QMI8658_IMU.cpp>
    -<Hardware/Sensors/MPU6886_IMU.cpp>
    -<Hardware/Display/Matrix5x5/*>
    -<Hardware/Display/Matrix8x8/*>
    -<Hardware/Power/AXP192.cpp>

; ======================================

[env:lilygo-t-qt]
extends = common_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = esp32-s3-devkitc-1
board_upload.flash_size = 4MB

lib_deps = 
    ${core_libs.lib_deps}
    moononournation/GFX Library for Arduino@^1.6.3

build_flags =
    ${debug_level.build_flags}
    -DBOARD_CONFIG_FILE=\"BoardConfigs/LilygoTQT_Config.h\"
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    -ULITTLE_FOOT_PRINT  ; CRITICAL: Enable text rendering in Arduino_GFX

; Build filter - exclude LED matrix and IMU-specific files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/QMI8658_IMU.cpp>
    -<Hardware/Sensors/MPU6886_IMU.cpp>
    -<Hardware/Display/Matrix5x5/*>
    -<Hardware/Display/Matrix8x8/*>
    -<Hardware/Power/AXP192.cpp>

; ======================================

[env:lilygo-t-qt-release]
extends = release_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = esp32-s3-devkitc-1
board_upload.flash_size = 4MB

lib_deps = 
    ${core_libs.lib_deps}
    moononournation/GFX Library for Arduino@^1.6.3

build_flags =
    ${release_debug_level.build_flags}
    -DBOARD_CONFIG_FILE=\"BoardConfigs/LilygoTQT_Config.h\"
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    -ULITTLE_FOOT_PRINT  ; CRITICAL: Enable text rendering in Arduino_GFX

; Build filter - exclude LED matrix and IMU-specific files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/QMI8658_IMU.cpp>
    -<Hardware/Sensors/MPU6886_IMU.cpp>
    -<Hardware/Display/Matrix5x5/*>
    -<Hardware/Display/Matrix8x8/*>
    -<Hardware/Power/AXP192.cpp>

; ======================================

[env:aipi-lite]
extends = common_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = esp32-s3-devkitc1-n16r8

lib_deps = 
    ${core_libs.lib_deps}
    moononournation/GFX Library for Arduino@^1.6.3

board_build.partitions = partitions/16M_OTA_noCD.csv

build_flags =
    ${debug_level.build_flags}
    -DBOARD_CONFIG_FILE=\"BoardConfigs/AIPI_Lite_Config.h\"
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1

; Build filter - exclude LED matrix and IMU-specific files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/QMI8658_IMU.cpp>
    -<Hardware/Sensors/MPU6886_IMU.cpp>
    -<Hardware/Display/Matrix5x5/*>
    -<Hardware/Display/Matrix8x8/*>
    -<Hardware/Power/AXP192.cpp>

; ======================================

[env:aipi-lite-release]
extends = release_settings
platform = 
    https://github.com/pioarduino/platform-espressif32/releases/download/55.03.32/platform-espressif32.zip
board = esp32-s3-devkitc1-n16r8

lib_deps = 
    ${core_libs.lib_deps}
    moononournation/GFX Library for Arduino@^1.6.3

board_build.partitions = partitions/16M_OTA_noCD.csv

build_flags =
    ${release_debug_level.build_flags}
    -DBOARD_CONFIG_FILE=\"BoardConfigs/AIPI_Lite_Config.h\"
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    -ULITTLE_FOOT_PRINT  ; CRITICAL: Enable text rendering in Arduino_GFX

; Build filter - exclude LED matrix and IMU-specific files
build_src_filter = 
    +<*>
    -<Hardware/Sensors/QMI8658_IMU.cpp>
    -<Hardware/Sensors/MPU6886_IMU.cpp>
    -<Hardware/Display/Matrix5x5/*>
    -<Hardware/Display/Matrix8x8/*>
    -<Hardware/Power/AXP192.cpp>

; //  --- EOF --- //